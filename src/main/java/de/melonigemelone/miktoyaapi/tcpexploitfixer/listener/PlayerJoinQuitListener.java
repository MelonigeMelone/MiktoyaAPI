package de.melonigemelone.miktoyaapi.tcpexploitfixer.listener;

import de.melonigemelone.miktoyaapi.MiktoyaAPI;
import de.melonigemelone.miktoyaapi.tcpexploitfixer.TCPExploitFixer;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.event.Event;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerLoginEvent;
import org.bukkit.event.player.PlayerQuitEvent;

/**
 *
 * PlayerJoinQuitListener
 *
 * ach erfolgreichem joinen wird in einer zweiten Tabelle bestÃ¤tigt, dass der Spieler auf dem Server ist.
 *
 * @author  MelonigeMelone
 * @version 1.0
 * @since   2021-01-16
 */

public class PlayerJoinQuitListener implements Listener {

    @EventHandler
    public void onJoin(PlayerLoginEvent e) {
        Player p = e.getPlayer();
        String uuid = p.getUniqueId().toString();

        TCPExploitFixer.getTcpExploitFixerMySQL().existsUUID(uuid, resultUUID ->  {
            TCPExploitFixer.getTcpExploitFixerMySQL().existsConnection(uuid, resultConnection -> {

                if((!resultUUID) || resultConnection) {

                    Bukkit.getScheduler().runTask(MiktoyaAPI.getInstance(), new Runnable() {
                        @Override
                        public void run() {
                           p.kickPlayer("Could not check your Connection, please retry it !");
                        }
                    });

                } else {
                    TCPExploitFixer.getTcpExploitFixerMySQL().addConnection(e.getPlayer().getUniqueId().toString());
                }
            });
        });

    }

    @EventHandler
    public void onQuit(PlayerQuitEvent e) {
        TCPExploitFixer.getTcpExploitFixerMySQL().delConnection(e.getPlayer().getUniqueId().toString());
    }
}
